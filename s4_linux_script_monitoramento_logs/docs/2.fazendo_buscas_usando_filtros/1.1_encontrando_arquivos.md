# Encontrando arquivos

Estamos trabalhando no nosso script de processamento de logs e temos uma variável que armazena o diretório onde estão os nossos logs.

Pode ser que dentro desse diretório existam outros arquivos que não queremos utilizar nesse processamento, pois não são arquivos de log. Então, vamos verificar o que temos dentro da pasta.

## Encontrando e filtrando arquivos

No terminal, vamos acessar a pasta "/myapp/logs" e executar o comando `ls` para listar os itens da pasta. Temos alguns arquivos com a extensão `.log`, mas também há outros com extensões diferentes que não queremos processar.

É interessante criar um filtro para processar somente os arquivos myapp-backend.log e myapp-frontend.log, que contêm as informações de log da nossa aplicação.

Para fazer esse filtro e obter somente os nomes dos arquivos que nos interessam, podemos usar o comando `find` no Linux. Vamos digitar:

    find . -name "*.log"

O retorno será:

    ./myapp-frontend.log

    ./myapp/backend.log

Esse comando retorna somente os nomes dos arquivos que terminam com .log. A seguir, vamos entender mais a fundo o que cada parte do comando faz.

O `find` realiza uma busca. O ponto especifica que a busca deve ser feita a partir do diretório atual. Caso queiramos buscar em outro diretório, podemos especificar o caminho no lugar do ponto.

A opção `-name` permite especificar o padrão de busca, no caso, o nome. Entre as aspas duplas, utilizamos o caractere especial de asterisco, que representa qualquer cadeia de caracteres em uma string. Assim, qualquer texto que termine com ".log" será retornado.

Portanto, esse comando filtra apenas os arquivo de log e podemos utilizá-lo no nosso script de monitoramento. Vamos copiar o comando com `"Ctrl + Shift + C"`, sair da pasta com cd e entrar na pasta do script com cd scripts-linux. Para abrir o script, digitamos vim monitoramento-logs.sh.

## Incrementando o script de monitoramento

No script, vamos habilitar a edição pressionando a tecla "I". Após o echo, pularemos uma linha e colaremos o comando copiado com "Ctrl + Shift + V":
```bash
#!/bin/bash

LOG_DIR="../myapp/logs"

echo "Verificando logs no diretorio $LOG_DIR"

find . -name "*.log"
```
Faremos algumas alterações no comando. Em vez de usar o ponto, chamaremos a variável LOG_DIR para utilizar o caminho do diretório onde estão armazenados os logs:
```bash
#!/bin/bash

LOG_DIR="../myapp/logs"

echo "Verificando logs no diretorio $LOG_DIR"

find $LOG_DIR -name "*.log"
```
Agora, podemos usar os nomes dos arquivos filtrados para percorrer cada um deles e fazer o devido processamento dos logs.

## Laços de repetição

Para percorrer o conteúdo, utilizamos laços de repetição. Basta especificar uma condição e, enquanto ela for verdadeira, executamos uma ação dentro do laço.

Para redirecionar a saída do comando find para um laço de repetição, usamos o operador pipe, que é uma barra vertical. O laço de repetição que utilizaremos é o while. Antes de especificar as condições e as ações do laço, vamos entender sua estrutura.

Começamos escrevendo `while`, que significa "enquanto" em inglês. Em seguida, definimos a condição e um ponto e vírgula. Depois, escrevemos `do`, que significa "faça" em inglês. O próximo passo é inserir as ações. Por fim, usamos a palavra `done`, que significa "feito" em inglês. Ou seja, todas as ações já foram feitas:
```bash
find $LOG_DIR -name "*.log" | while [condição]; do
    [ações]
done
```
 Os trechos entre colchetes serão substituídos a seguir.

Na sequência, vamos especificamos a condição e as ações a serem realizadas. Para a condição, usaremos o `IFS= (Internal Field Separator)` definido como vazio, para evitar que nomes de arquivos com espaços ou caracteres especiais sejam quebrados:

```bash
find $LOG_DIR -name "*.log" | while IFS= ; do
    ações
done
```
Em seguida, usamos read para ler os arquivos passados pelo find, com algumas opções extras. A opção `-r` impede a interpretação caracteres especiais e `-d` '' indica que delimitador é o caractere nulo:

```bash
find $LOG_DIR -name "*.log" | while IFS= read -r -d ''; do
    ações
done
```
Por padrão, o find não utiliza o delimitador nulo. Para alterar essa configuração, vamos inserir -print0 antes do pipe, garantindo que a saída do find utilize o delimitador nulo, que é esperado pelo read:

```bash
find $LOG_DIR -name "*.log" -print0 | while IFS= read -r -d ''; do
    ações
done
```
Por fim, especificaremos uma variável arquivo para armazenar o nome dos arquivos de log. Assim, conseguiremos trabalhar com cada um deles individualmente:

```bash
find $LOG_DIR -name "*.log" -print0 | while IFS= read -r -d '' arquivo; do
    ações
done
```
Para verificar se o laço está funcionando, vamos incluir uma ação nele. Chamaremos echo "Arquivo encontrado $arquivo":

```bash
find $LOG_DIR -name "*.log" -print0 | while IFS= read -r -d '' arquivo; do
    echo "Arquivo encontrado $arquivo"
done
```
Vamos sair do modo de inserção com "Esc". Para salvar e sair do Vim, em vez de usar os comandos :w e :q individualmente, podemos concatená-los assim: :wq.

Para executar o script, rodamos:

    ./monitoramento-logs.sh

No terminal, temos a seguinte a saída:

    Verificando logs no diretorio ../myapp/logs

    Arquivo encontrado: ../myapp/logs/myapp-frontend.log

    Arquivo encontrado: ../myapp/logs/myapp-backend.log

O laço de repetição e o comando find estão encontrando os arquivos, o que nos permitirá realizar o processamento na aula a seguir.