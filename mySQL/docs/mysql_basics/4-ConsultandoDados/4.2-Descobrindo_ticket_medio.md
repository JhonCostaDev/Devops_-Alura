## Descobrindo o ticket médio

Vamos começar fazendo o SELECT, para selecionar o registro, o que queremos trazer. Como queremos trazer as informações das pessoas usuárias, então qual o ID da pessoa usuária tem o valor de ticket médio, vamos selecionar a coluna de **cliente_id**.

E qual é a função que usamos para trazer a média do valor? A função que usamos no SQL para trazer a média do valor é a **average**, que representamos na nossa query como **AVG**. Essa função traz a média de valores numéricos.

No caso, vamos colocar **AVG** entre parênteses, a coluna que queremos trazer a média, que é a coluna de preço total. E aí, vamos trazer um apelido para essa coluna nova de média que vamos criar na consulta. Então, como é o ticket médio que queremos saber, vamos dar esse nome para nossa coluna. Então, colocamos as, e aí nomeamos como **ticket_medio**.

Queremos trazer essas informações de qual tabela? Da tabela de alugueis. Então, colocamos aqui FROM alugueis. E essas funções de agregação, como média, entre outras, normalmente precisamos usar a cláusula GROUP BY na sequência, porque ela pede para agruparmos por alguma outra informação. Isso nos permite calcular essa média e trazer agrupada outra coluna que tem nessa tabela.

Para nós, faz sentido agrupar por cliente mesmo, porque aí vamos saber quanto cada pessoa gastou na plataforma e ter uma noção de qual está sendo o valor que cada pessoa está desembolsando na plataforma. Então, vamos colocar agora a cláusula GROUP BY e a coluna que queremos trazer agrupada, que é a de cliente_id. Vamos colocar o ponto e vírgula, e agora vamos rodar a nossa consulta.

```SQL
SELECT cliente_id, AVG(preco_total) AS ticket_medio
FROM alugueis
GROUP BY cliente_id;
```
Se observarmos o resultado, veio a coluna de cliente_id e ao lado o ticket_medio. Vieram vários zeros depois do ponto, porque não determinamos a quantidade de casas decimais, poderíamos ter determinado, mas não vai interferir que conseguimos saber o valor correto, que é R$ 3.240 para a pessoa de ID 1, a pessoa de ID 10, R$ 2.766, a pessoa de ID 100, R$ 452 e assim por diante.

      cliente_id	  ticket_medio
          1	        3240.000000
          10	      2766.000000
          100	      452.000000
          1000	    3704.000000
          10000	    708.000000
          
Assim, a Insight Places tem uma lista com o ticket médio de cada pessoa usuária. Então, essa informação vai ajudar a Insight Places a criar algumas estratégias de marketing, a conhecer melhor as pessoas usuárias, saber quanto cada uma está gastando na plataforma.

## Descobrindo a média de tempo de cada reserva

Outra informação que a Insight Places pediu para trazermos, para ela conhecer melhor as pessoas usuárias, é a média de dias de cada reserva, porque ela tem interesse em saber qual é a quantidade de dias mais procurada para a reserva para as pessoas usuárias. Ela vai fazer alguns pacotes promocionais já visando essa quantidade de dias específico para ter mais aceitação na plataforma.

Como podemos trazer essa informação? Vamos abrir uma nova aba de consulta na parte superior esquerda, e aí vamos começar a estruturar essa nova consulta.

Vamos fazer o SELECT, também buscar os registros da coluna de cliente_id, porque são informações que queremos saber de cada cliente, então faz sentido trazermos essa coluna de registros dos ID de clientes para sabermos de qual pessoa se trata.

E aí também vamos usar a nossa função de calcular a média, porque queremos saber uma média também, só que agora de dias, não de valor financeiro.

Colocamos, então, a função AVG, e dentro do parênteses vamos colocar uma função específica que trabalha com dados do tipo data, que ela traz essa diferença em dias, em valor numérico, de uma data inicial e uma data final. É exatamente isso o que precisamos fazer aqui na nossa consulta para conseguirmos trazer esse valor para Insight Places.

Como na tabela de aluguéis temos uma coluna que é de data início e data fim de cada reserva, conseguimos aplicar essa função específica nessas duas colunas e trazer a informação de intervalo de dias para calcularmos a média desse valor.

Vamos colocar a função que é DATEDIFF, e aí vamos abrir aqui um novo parêntese depois dessa função para especificar quais são as colunas que vamos medir esse intervalo de dias.

Então, é a coluna data_fim e a coluna data_inicio. Agora vamos fechar os dois parênteses, porque abrimos um primeiro e depois que escrevemos a função DATEDIFF abrimos o segundo, e agora vamos colocar um apelido para esse valor que vai vir. Então, vamos colocar as, pode ser media_dias_estadia, para sabermos do que se trata.

E aí vamos determinar de qual tabela que vão vir todas essas informações, que é a tabela de aluguéis, que é a mesma tabela que já estávamos trabalhando na última consulta. Então, FROM alugueis.

Também temos que usar uma cláusula GROUP BY, porque como estamos trabalhando com a média, a linguagem pede para agruparmos por alguma outra informação.

Então, vamos agrupar por cliente_id. E vamos ordenar também essa consulta em ordem decrescente. Então, da maior reserva para a menor, só para conseguirmos analisar esse número de uma forma mais organizada. Então, ORDER BY media_dias_estadia DESC. Vamos colocar o ponto e vírgula e rodar nossa consulta.

```SQL

SELECT cliente_id, AVG(DATEDIFF(data_fim, data_inicio)) AS media_dias_estadia
FROM alugueis
GROUP BY cliente_id
ORDER BY media_dias_estadia DESC;
```

Conseguimos analisar o resultado, que deu uma média de 7 dias de estadia para praticamente todas as pessoas usuárias. E aí a Insight Places, ela vai usar essa informação, porque ela consegue analisar que a maior parte das pessoas usuárias fecha pacote de 7 dias e ela vai poder fazer algumas promoções e reservas com esse valor específico de dias e vai ter mais aceitação do público dela.

cliente_id	media_dias_estadia
845	7.0000
8454	7.0000
8469	7.0000
8475	7.0000
8480	7.0000
Então, conseguimos trazer algumas informações bem importantes para a Insight Places e ela vai usar para as campanhas e para a estratégia de marketing dela.


## Question

A empresa XYZ deseja analisar o desempenho médio de vendas dos seus produtos ao longo do último ano para identificar áreas de melhoria e oportunidades de crescimento. A tabela vendas no banco de dados contém as colunas:
  * produto_id, 
  * quantidade_vendida, 
  * preco_venda e 
  * data_venda. 
  
A empresa está interessada em calcular o preço médio de venda de cada produto ao longo do último ano.

SELECT produto_id avg(preco_venda) as preco_medio_venda
FROM vendas 
GROUP BY produto_id
ORDER BY DESC;

Qual das seguintes consultas SQL utilizará corretamente a função AVG para calcular o preço médio de venda de cada produto no último ano?

```SQL
SELECT produto_id, AVG(preco_venda) AS preco_medio
FROM vendas
WHERE data_venda BETWEEN DATE_SUB(CURDATE(), INTERVAL 1 YEAR) AND CURDATE()
GROUP BY produto_id;
```
Esta consulta calcula o preço médio de venda (AVG(preco_venda)) para cada produto, filtrando as vendas para o último ano e agrupando os resultados por produto_id, que é exatamente o que a empresa deseja analisar.